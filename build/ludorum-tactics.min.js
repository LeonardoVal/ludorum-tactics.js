//! ludorum-tactics 0.0.1

!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","ludorum"],b):"object"==typeof module&&module.exports?module.exports=b(require("creatartis-base"),require("ludorum")):a.ludorum_gamepack=b(a.base,a.ludorum)}(this,function a(b,c){"use strict";{var d=b.declare,e=b.iterable,f=b.initialize,g=c.Game,h=b.raise,i=(b.raiseIf,{__name__:"ludorum-tactics",__init__:a,__dependencies__:[b,c]});i.TacticsPiece=d({constructor:function(a){f(this,a).string("owner").array("position",{length:2,elementType:b.types.INTEGER}).number("damage",{defaultValue:0}).integer("movement",{ignore:!0,minimum:0}).integer("hp",{ignore:!0,minimum:1}).number("attackChance",{ignore:!0,minimum:0,maximum:1}).number("attackDamage",{ignore:!0,minimum:1}).number("attackRange",{ignore:!0,minimum:0}).number("defenseChance",{ignore:!0,minimum:0,maximum:1})},name:"TacticsPiece",movement:2,hp:10,attackChance:.5,attackDamage:10,attackRange:4,defenseChance:.3,clone:function(){return new this.constructor(this)},isDestroyed:function(){return this.hp<=this.damage},moves:function(a){for(var b,c,d,f,g,h={},i=[this.position],j=0;j<=this.movement;j++)b=i,i=[],b.forEach(function(b){b in h||(h[b]=b,c=[b[0],b[1]+1],d=[b[0]-1,b[1]],f=[b[0]+1,b[1]],g=[b[0],b[1]-1],[c,d,f,g].forEach(function(b){a.isPassable(b)&&i.push(b)}))});return e(h).select(1).toArray()},moveTo:function(a){var b=this.clone();return b.position=a,b},bresenham:function(a,b){var c=this.position[0],d=this.position[1],e=b[0],f=b[1],g=Math.abs(e-c),h=Math.abs(f-d);if(1>=g&&1>=h)return!0;for(var i,j=e>c?1:-1,k=f>d?1:-1,l=(g>h?g:-h)/2;c!==e||d!==f;){if(!a.isClear([c,d]))return!1;i=l,i>-g&&(l-=h,c+=j),h>i&&(l+=g,d+=k)}return!0},pieceInLineOfSight:function(a,b){return this.inLineOfSight(a,b.position)},inLineOfSight:function(a,b){return this.bresenham(a,b)},possibleAttacks:function(a){var b=this;return e(a.pieces).filter(function(c){if(c!==b&&c.owner!=b.owner){var d=Math.sqrt(Math.pow(b.position[0]-c.position[0],2)+Math.pow(b.position[1]-c.position[1],2));return d<=b.attackRange&&b.pieceInLineOfSight(a,c)}return!1},function(a,b){return b}).toArray()},attack:function(a){return a=a.clone(),a.damage+=this.attackDamage*this.attackChance*(1-a.defenseChance),a},toString:function(){return this.name+"("+this.owner+"@"+this.position+" "+(this.hp-this.damage)+"/"+this.hp+")"}}),i.TacticsGame=d(g,{name:"TacticsGame",players:["Left","Right"],constructor:function(a,b,c){b=0|b,a[b]||h("Current piece ",b," is not valid (pieces: ",JSON.stringify(a),")!"),g.call(this,a[b].owner),this.pieces=a,this.currentPiece=b,this.hasMoved=!!c,this.__piecesByPosition__=e(a).map(function(a){return[a.position+"",a]}).toObject()},terrain:new c.utils.CheckerboardFromString(10,15,"...x..............x.....o............xxo..............#..............#.......oo#............oox..................oox........xx..................#....."),isPassable:function(a){return".x".indexOf(this.terrain.square(a))>=0&&!this.__piecesByPosition__[a+""]},isClear:function(a){return".o".indexOf(this.terrain.square(a))>=0},moves:function(){if(!this.hasOwnProperty("__moves__")){var a=this.pieces[this.currentPiece];a&&!this.result()?(this.__moves__={},this.hasMoved?this.__moves__[a.owner]=["pass"].concat(a.possibleAttacks(this)):this.__moves__[a.owner]=a.moves(this)):this.__moves__=null}return this.__moves__},next:function(a){var b=this.pieces[this.currentPiece],c=this.pieces.concat([]);a.hasOwnProperty(b.owner)||(console.log(this+"\n"+JSON.stringify(a)+" from "+JSON.stringify(this.moves())+"!"),delete this.__moves__,console.log("	"+JSON.stringify(this.moves())+"?"),h("Active player ",b.owner," has no moves in ",JSON.stringify(a),"!"));var d=a[b.owner];if(this.hasMoved){var e=this.currentPiece+1;if("pass"!==d){var f=this.pieces[d],g=b.attack(f);g.isDestroyed()?(d<this.currentPiece&&e--,c.splice(d,1)):c[d]=g}return new this.constructor(c,e%c.length,!1)}return c[this.currentPiece]=b.moveTo(d),new this.constructor(c,this.currentPiece,!0)},result:function(){var a=this,b=e(this.players).map(function(b){var c=a.pieces.filter(function(a){return a.owner===b}).length;return[b,c]}).toObject();return b.Left<1?this.victory("Right",b.Right):b.Right<1?this.victory("Left",b.Left):null},__serialize__:function(){return[this.name,this.pieces,this.currentPiece,this.hasMoved]},toString:function(){var a=this;return this.name+"("+this.currentPiece+":"+this.pieces[this.currentPiece]+" "+(this.hasMoved?"attacks":"moves")+this.pieces.map(function(b,c){return c===a.currentPiece?"":", "+c+":"+b}).join("")+")"}})}return i});
//# sourceMappingURL=ludorum-tactics.min.js.map